<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <title>Home - This Page</title>
  <style>
    body {
      background:url("/static/image.png");
    }
  </style>
</head>
<body data-source-path="templates/index.html" class="bg-neutral-950 text-neutral-300 font-sans antialiased min-h-screen relative">
  <div class="max-w-4xl mx-auto py-20 px-6">
    <nav class="flex gap-6 border-b border-neutral-800 pb-6 w-full mb-8">
  <a href='/' class="text-xs uppercase tracking-widest hover:text-white transition-colors">Home</a>
</nav>
    
    <main class="mt-12 min-h-[50vh] relative">
        <!-- Empty State Message -->
        <div class="empty-state absolute inset-0 flex items-center justify-center border-2 border-dashed border-neutral-800 rounded-lg">
            <a href="/admin" class="text-neutral-700 hover:text-neutral-500 text-sm font-mono transition-colors">
                Login to start building
            </a>
        </div>
    </main>
  </div>
  
  <!-- The Add Content Button (Visible only in Admin Mode) -->
  <div class="thispage-add-btn hidden fixed bottom-8 right-8 z-50 cursor-pointer hover:scale-110 transition-transform group">
        <div class="w-14 h-14 rounded-full bg-blue-600 flex items-center justify-center text-white text-3xl font-bold shadow-lg hover:bg-blue-500 transition-colors">
            +
        </div>
        <div class="absolute right-full mr-4 top-1/2 -translate-y-1/2 bg-neutral-900 text-white text-xs px-3 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap pointer-events-none">
            Add Block
        </div>
  </div>

<script>
  (function() {
    const params = new URLSearchParams(window.location.search);
    if (params.get('is_admin') === 'true') {
      // 1. Inject Styles for Blocks
      const style = document.createElement('style');
      style.textContent = 
        ".thispage-block:hover {" +
            "outline: 2px solid #3b82f6;" +
            "cursor: pointer;" +
            "position: relative;" +
        "}" +
        ".thispage-block:hover::after {" +
            "content: 'Edit';" +
            "position: absolute;" +
            "top: -20px;" +
            "right: 0;" +
            "background: #3b82f6;" +
            "color: white;" +
            "font-size: 10px;" +
            "padding: 2px 6px;" +
            "border-radius: 2px;" +
            "font-family: sans-serif;" +
            "pointer-events: none;" +
        "}";
      document.head.appendChild(style);

      // 2. Toggle Admin UI Elements
      document.querySelectorAll('.thispage-add-btn').forEach(el => el.classList.remove('hidden'));
      document.querySelectorAll('.empty-state').forEach(el => el.style.display = 'none');

      // 3. Inject Back to Admin Button
      const sourcePath = document.body.getAttribute('data-source-path');
      if (sourcePath) {
          const backBtn = document.createElement('a');
          backBtn.href = '/admin/files/view?path=' + encodeURIComponent(sourcePath);
          backBtn.textContent = 'Back to Edit';
          backBtn.style.cssText = 'position:fixed;bottom:2rem;left:2rem;z-index:9999;background:#171717;color:white;padding:0.5rem 1rem;border-radius:0.375rem;font-family:sans-serif;font-size:0.875rem;text-decoration:none;border:1px solid #404040;box-shadow:0 4px 6px -1px rgba(0,0,0,0.1);';
          backBtn.onmouseover = () => backBtn.style.background = '#262626';
          backBtn.onmouseout = () => backBtn.style.background = '#171717';
          document.body.appendChild(backBtn);
      }

      // 4. Intercept Links to Persist Admin State
      document.addEventListener('click', function(e) {
        // Add Button Handler
        if (e.target.closest('.thispage-add-btn')) {
             e.preventDefault();
             e.stopPropagation();
             
             // Fetch partials
             fetch('/admin/api/partials')
                .then(res => res.json())
                .then(data => {
                    // Create and show modal
                    let modal = document.getElementById('partial-modal');
                    if (!modal) {
                        modal = document.createElement('div');
                        modal.id = 'partial-modal';
                        modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);z-index:9999;display:flex;align-items:center;justify-content:center;';
                        
                        const content = document.createElement('div');
                        content.style.cssText = 'background:#171717;border:1px solid #404040;padding:24px;border-radius:8px;width:300px;color:white;';
                        
                        const title = document.createElement('h3');
                        title.textContent = 'Insert Block';
                        title.style.cssText = 'font-weight:bold;margin-bottom:16px;text-transform:uppercase;letter-spacing:1px;font-size:12px;color:#a3a3a3;';
                        content.appendChild(title);
                        
                        const list = document.createElement('ul');
                        list.id = 'partial-list';
                        content.appendChild(list);

                        const close = document.createElement('button');
                        close.textContent = 'Cancel';
                        close.style.cssText = 'margin-top:16px;width:100%;padding:8px;background:transparent;border:1px solid #404040;color:#a3a3a3;cursor:pointer;font-size:12px;text-transform:uppercase;letter-spacing:1px;';
                        close.onclick = () => modal.style.display = 'none';
                        content.appendChild(close);
                        
                        modal.appendChild(content);
                        document.body.appendChild(modal);
                    }
                    
                    const list = document.getElementById('partial-list');
                    list.innerHTML = ''; // clear
                    
                    data.files.forEach(file => {
                        const item = document.createElement('li');
                        item.textContent = file;
                        item.style.cssText = 'padding:12px;background:#262626;margin-bottom:8px;cursor:pointer;border-radius:4px;font-size:14px;';
                        item.onmouseover = () => item.style.background = '#404040';
                        item.onmouseout = () => item.style.background = '#262626';
                        
                        item.onclick = () => {
                             const sourcePath = document.body.getAttribute('data-source-path');
                             fetch('/admin/api/insert-partial', {
                                method: 'POST',
                                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                                body: 'target_file=' + encodeURIComponent(sourcePath) + '&partial_name=' + encodeURIComponent('partials/' + file)
                             }).then(res => {
                                 if (res.ok) {
                                     window.location.reload();
                                 } else {
                                     alert('Error inserting partial');
                                 }
                             });
                        };
                        list.appendChild(item);
                    });
                    
                    modal.style.display = 'flex';
                });
             return;
        }

        // Block Click Handler
        if (e.target.classList.contains('thispage-block')) {
            e.preventDefault();
            e.stopPropagation();
            console.log("Block clicked:", e.target);
            alert("Edit block functionality coming soon!");
            return;
        }

        const link = e.target.closest('a');
        if (link && link.href) {
            const url = new URL(link.href, window.location.origin);
            // Only modify internal links
            if (url.origin === window.location.origin) {
                // specific check to avoid duplicating or messing up non-nav links
                if (!url.searchParams.has('is_admin')) {
                    url.searchParams.set('is_admin', 'true');
                    link.href = url.toString();
                }
            }
        }
      });
    }
  })();
</script></body>
</html>